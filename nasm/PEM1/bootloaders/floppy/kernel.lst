     1                                  ; ==================================================================
     2                                  ; MikeOS -- The Mike Operating System kernel
     3                                  ; Copyright (C) 2006 - 2013 MikeOS Developers -- see doc/LICENSE.TXT
     4                                  ;
     5                                  ; This is loaded from the drive by BOOTLOAD.BIN, as KERNEL.BIN.
     6                                  ; First we have the system call vectors, which start at a static point
     7                                  ; for programs to use. Following that is the main kernel code and
     8                                  ; then additional system call code is included.
     9                                  ; ==================================================================
    10                                  
    11                                  
    12                                  	BITS 16
    13                                  
    14                                  	%DEFINE VERSION '1.0'    	; OS version number
    15                                  
    16                                  	; This is the location in RAM for kernel disk operations, 24K
    17                                  	; after the point where the kernel has loaded; it's 8K in size,
    18                                  	; because external programs load after it at the 32K point:
    19                                  
    20                                  	disk_buffer	equ	24576
    21                                  
    22                                  
    23                                  ; ------------------------------------------------------------------
    24                                  ; OS CALL VECTORS -- Static locations for system call vectors
    25                                  ; Note: these cannot be moved, or it'll break the calls!
    26                                  
    27                                  ; The comments show exact locations of instructions in this section,
    28                                  ; and are used in programs/mikedev.inc so that an external program can
    29                                  ; use a MikeOS system call without having to know its exact position
    30                                  ; in the kernel source code...
    31                                  
    32                                  os_call_vectors:
    33 00000000 EB00                    	jmp os_main			; 0000h -- Called from bootloader
    34                                  ;	jmp os_print_string		; 0003h
    35                                  ;	jmp os_move_cursor		; 0006h
    36                                  ;	jmp os_clear_screen		; 0009h
    37                                  ;	jmp os_print_horiz_line		; 000Ch
    38                                  ;	jmp os_print_newline		; 000Fh
    39                                  ;	jmp os_wait_for_key		; 0012h
    40                                  ;	jmp os_check_for_key		; 0015h
    41                                  ;	jmp os_int_to_string		; 0018h
    42                                  ;	jmp os_speaker_tone		; 001Bh
    43                                  ;	jmp os_speaker_off		; 001Eh
    44                                  ;	jmp os_load_file		; 0021h
    45                                  ;	jmp os_pause			; 0024h
    46                                  ;	jmp os_fatal_error		; 0027h
    47                                  ;	jmp os_draw_background		; 002Ah
    48                                  ;	jmp os_string_length		; 002Dh
    49                                  ;	jmp os_string_uppercase		; 0030h
    50                                  ;	jmp os_string_lowercase		; 0033h
    51                                  ;	jmp os_input_string		; 0036h
    52                                  ;	jmp os_string_copy		; 0039h
    53                                  ;	jmp os_dialog_box		; 003Ch
    54                                  ;	jmp os_string_join		; 003Fh
    55                                  ;	jmp os_get_file_list		; 0042h
    56                                  ;	jmp os_string_compare		; 0045h
    57                                  ;	jmp os_string_chomp		; 0048h
    58                                  ;	jmp os_string_strip		; 004Bh
    59                                  ;	jmp os_string_truncate		; 004Eh
    60                                  ;	jmp os_bcd_to_int		; 0051h
    61                                  ;	jmp os_get_time_string		; 0054h
    62                                  ;	jmp os_get_api_version		; 0057h
    63                                  ;	jmp os_file_selector		; 005Ah
    64                                  ;	jmp os_get_date_string		; 005Dh
    65                                  ;	jmp os_send_via_serial		; 0060h
    66                                  ;	jmp os_get_via_serial		; 0063h
    67                                  ;	jmp os_find_char_in_string	; 0066h
    68                                  ;	jmp os_get_cursor_pos		; 0069h
    69                                  ;	jmp os_print_space		; 006Ch
    70                                  ;	jmp os_dump_string		; 006Fh
    71                                  ;	jmp os_print_digit		; 0072h
    72                                  ;	jmp os_print_1hex		; 0075h
    73                                  ;	jmp os_print_2hex		; 0078h
    74                                  ;	jmp os_print_4hex		; 007Bh
    75                                  ;	jmp os_long_int_to_string	; 007Eh
    76                                  ;	jmp os_long_int_negate		; 0081h
    77                                  ;	jmp os_set_time_fmt		; 0084h
    78                                  ;	jmp os_set_date_fmt		; 0087h
    79                                  ;	jmp os_show_cursor		; 008Ah
    80                                  ;	jmp os_hide_cursor		; 008Dh
    81                                  ;	jmp os_dump_registers		; 0090h
    82                                  ;	jmp os_string_strincmp		; 0093h
    83                                  ;	jmp os_write_file		; 0096h
    84                                  ;	jmp os_file_exists		; 0099h
    85                                  ;	jmp os_create_file		; 009Ch
    86                                  ;	jmp os_remove_file		; 009Fh
    87                                  ;	jmp os_rename_file		; 00A2h
    88                                  ;	jmp os_get_file_size		; 00A5h
    89                                  ;	jmp os_input_dialog		; 00A8h
    90                                  ;	jmp os_list_dialog		; 00ABh
    91                                  ;	jmp os_string_reverse		; 00AEh
    92                                  ;	jmp os_string_to_int		; 00B1h
    93                                  ;	jmp os_draw_block		; 00B4h
    94                                  ;	jmp os_get_random		; 00B7h
    95                                  ;	jmp os_string_charchange	; 00BAh
    96                                  ;	jmp os_serial_port_enable	; 00BDh
    97                                  ;	jmp os_sint_to_string		; 00C0h
    98                                  ;	jmp os_string_parse		; 00C3h
    99                                  ;	jmp os_run_basic		; 00C6h
   100                                  ;	jmp os_port_byte_out		; 00C9h
   101                                  ;	jmp os_port_byte_in		; 00CCh
   102                                  ;	jmp os_string_tokenize		; 00CFh
   103                                  
   104                                  
   105                                  ; ------------------------------------------------------------------
   106                                  ; START OF MAIN KERNEL CODE
   107                                  
   108                                  os_main:
   109 00000002 FA                      	cli				; Clear interrupts
   110 00000003 B80000                  	mov ax, 0
   111 00000006 8ED0                    	mov ss, ax			; Set stack segment and pointer
   112 00000008 BCFFFF                  	mov sp, 0FFFFh
   113 0000000B FB                      	sti				; Restore interrupts
   114                                  
   115 0000000C FC                      	cld				; The default direction for string operations
   116                                  					; will be 'up' - incrementing address in RAM
   117                                  
   118 0000000D B80020                  	mov ax, 2000h			; Set all segments to match where kernel is loaded
   119 00000010 8ED8                    	mov ds, ax			; After this, we don't need to bother with
   120 00000012 8EC0                    	mov es, ax			; segments ever again, as MikeOS and its programs
   121 00000014 8EE0                    	mov fs, ax			; live entirely in 64K
   122 00000016 8EE8                    	mov gs, ax
   123                                  
   124 00000018 80FA00                  	cmp dl, 0
   125 0000001B 741B                    	je no_change
   126 0000001D 8816[A400]              	mov [bootdev], dl		; Save boot device number
   127 00000021 06                      	push es
   128 00000022 B408                    	mov ah, 8			; Get drive parameters
   129 00000024 CD13                    	int 13h
   130 00000026 07                      	pop es
   131 00000027 83E13F                  	and cx, 3Fh			; Maximum sector number
   132 0000002A 890E[A200]              	mov [SecsPerTrack], cx		; Sector numbers start at 1
   133 0000002E 0FB6D6                  	movzx dx, dh			; Maximum head number
   134 00000031 83C201                  	add dx, 1			; Head numbers start at 0 - add 1 for total
   135 00000034 8916[A000]              	mov [Sides], dx
   136                                  
   137                                  no_change:
   138 00000038 B80310                  	mov ax, 1003h			; Set text output with certain attributes
   139 0000003B BB0000                  	mov bx, 0			; to be bright, and not blinking
   140 0000003E CD10                    	int 10h
   141                                  
   142                                  ;	call os_seed_random		; Seed random number generator
   143                                  
   144                                  
   145                                  	; Let's see if there's a file called AUTORUN.BIN and execute
   146                                  	; it if so, before going to the program launcher menu
   147                                  
   148                                  ;	mov ax, autorun_bin_file_name
   149                                  ;	call os_file_exists
   150                                  ;	jc no_autorun_bin		; Skip next three lines if AUTORUN.BIN doesn't exist
   151                                  
   152                                  ;	mov cx, 32768			; Otherwise load the program into RAM...
   153                                  ;	call os_load_file
   154                                  ;	jmp execute_bin_program		; ...and move on to the executing part
   155                                  
   156                                  
   157                                  	; Or perhaps there's an AUTORUN.BAS file?
   158                                  
   159                                  ;no_autorun_bin:
   160                                  ;	mov ax, autorun_bas_file_name
   161                                  ;	call os_file_exists
   162                                  ;	jc option_screen		; Skip next section if AUTORUN.BAS doesn't exist
   163                                  
   164                                  ;	mov cx, 32768			; Otherwise load the program into RAM
   165                                  ;	call os_load_file
   166                                  ;	call os_clear_screen
   167                                  ;	mov ax, 32768
   168                                  ;	call os_run_basic		; Run the kernel's BASIC interpreter
   169                                  
   170                                  ;	jmp app_selector		; And go to the app selector menu when BASIC ends
   171                                  
   172                                  
   173                                  	; Now we display a dialog box offering the user a choice of
   174                                  	; a menu-driven program selector, or a command-line interface
   175                                  
   176                                  ;option_screen:
   177                                          ; CLEAR SCREEN
   178                                  ClearScreen:        
   179 00000040 60                              pusha
   180                                  
   181 00000041 BA0000                          mov dx, 0                       ; Position cursor at top-left
   182 00000044 E82300                          call os_move_cursor
   183                                  
   184 00000047 B406                            mov ah, 6                       ; Scroll full-screen
   185 00000049 B000                            mov al, 0                       ; Normal white on black
   186 0000004B B707                            mov bh, 7                       ;
   187 0000004D B90000                          mov cx, 0                       ; Top-left
   188 00000050 B618                            mov dh, 24                      ; Bottom-right
   189 00000052 B24F                            mov dl, 79
   190 00000054 CD10                            int 10h
   191                                  
   192 00000056 61                              popa
   193                                  
   194 00000057 BE[7300]                        mov     si, os_init_msg
   195                                  print_string:
   196 0000005A 60                              pusha
   197                                  
   198 0000005B B40E                            mov ah, 0Eh                     ; int 10h teletype function
   199                                  
   200                                  .repeat:
   201 0000005D AC                              lodsb                           ; Get char from string
   202 0000005E 3C00                            cmp al, 0
   203 00000060 7404                            je .done                        ; If char is zero, end of string
   204                                  
   205 00000062 CD10                            int 10h                         ; Otherwise, print it
   206 00000064 EBF7                            jmp .repeat                     ; And move on to next char
   207                                  
   208                                  .done:
   209 00000066 61                              popa        
   210                                          
   211                                  os_loop:        
   212 00000067 F4                              hlt
   213 00000068 EBFD                            jmp     os_loop
   214                                          
   215                                  os_move_cursor:
   216 0000006A 60                              pusha
   217                                  
   218 0000006B B700                            mov bh, 0
   219 0000006D B402                            mov ah, 2
   220 0000006F CD10                            int 10h                         ; BIOS interrupt to move cursor
   221                                  
   222 00000071 61                              popa
   223 00000072 C3                              ret
   224                                          
   225                                  ;	mov ax, os_init_msg		; Set up the welcome screen
   226                                  ;	mov bx, os_version_msg
   227                                  ;	mov cx, 10011111b		; Colour: white text on light blue
   228                                  ;	call os_draw_background
   229                                  
   230                                  ;	mov ax, dialog_string_1		; Ask if user wants app selector or command-line
   231                                  ;	mov bx, dialog_string_2
   232                                  ;	mov cx, dialog_string_3
   233                                  ;	mov dx, 1			; We want a two-option dialog box (OK or Cancel)
   234                                  ;	call os_dialog_box
   235                                  
   236                                  ;	cmp ax, 1			; If OK (option 0) chosen, start app selector
   237                                  ;	jne near app_selector
   238                                  ;
   239                                  ;	call os_clear_screen		; Otherwise clean screen and start the CLI
   240                                  ;	call os_command_line
   241                                  ;
   242                                  ;	jmp option_screen		; Offer menu/CLI choice after CLI has exited
   243                                  
   244                                  
   245                                  	; Data for the above code...
   246                                  
   247 00000073 50454D20312053696D-     	os_init_msg		db 'PEM 1 Simulator by Agguro - Version ', VERSION, 10, 13, 0
   248 0000007C 756C61746F72206279-
   249 00000085 2041676775726F202D-
   250 0000008E 2056657273696F6E20-
   251 00000097 312E300A0D00       
   252                                  
   253                                  ;	dialog_string_1		db 'Thanks for trying out MikeOS!', 0
   254                                  ;	dialog_string_2		db 'Please select an interface: OK for the', 0
   255                                  ;	dialog_string_3		db 'program menu, Cancel for command line.', 0
   256                                  
   257                                  
   258                                  
   259                                  ;app_selector:
   260                                  ;	mov ax, os_init_msg		; Draw main screen layout
   261                                  ;	mov bx, os_version_msg
   262                                  ;	mov cx, 10011111b		; Colour: white text on light blue
   263                                  ;	call os_draw_background
   264                                  
   265                                  ;	call os_file_selector		; Get user to select a file, and store
   266                                  ;					; the resulting string location in AX
   267                                  					; (other registers are undetermined)
   268                                  
   269                                  ;	jc option_screen		; Return to the CLI/menu choice screen if Esc pressed
   270                                  ;
   271                                  ;	mov si, ax			; Did the user try to run 'KERNEL.BIN'?
   272                                  ;	mov di, kern_file_name
   273                                  ;	call os_string_compare
   274                                  ;	jc no_kernel_execute		; Show an error message if so
   275                                  
   276                                  
   277                                  	; Next, we need to check that the program we're attempting to run is
   278                                  	; valid -- in other words, that it has a .BIN extension
   279                                  
   280                                  ;	push si				; Save filename temporarily
   281                                  ;
   282                                  ;	mov bx, si
   283                                  ;	mov ax, si
   284                                  ;	call os_string_length
   285                                  
   286                                  ;	mov si, bx
   287                                  ;	add si, ax			; SI now points to end of filename...
   288                                  ;
   289                                  ;	dec si
   290                                  ;	dec si
   291                                  ;	dec si				; ...and now to start of extension!
   292                                  
   293                                  ;	mov di, bin_ext
   294                                  ;	mov cx, 3
   295                                  ;	rep cmpsb			; Are final 3 chars 'BIN'?
   296                                  ;	jne not_bin_extension		; If not, it might be a '.BAS'
   297                                  
   298                                  ;	pop si				; Restore filename
   299                                  
   300                                  
   301                                  ;	mov ax, si
   302                                  ;	mov cx, 32768			; Where to load the program file
   303                                  ;	call os_load_file		; Load filename pointed to by AX
   304                                  
   305                                  
   306                                  ;execute_bin_program:
   307                                  ;	call os_clear_screen		; Clear screen before running
   308                                  
   309                                  ;	mov ax, 0			; Clear all registers
   310                                  ;	mov bx, 0
   311                                  ;	mov cx, 0
   312                                  ;	mov dx, 0
   313                                  ;	mov si, 0
   314                                  ;	mov di, 0
   315                                  
   316                                  ;	call 32768			; Call the external program code,
   317                                  					; loaded at second 32K of segment
   318                                  					; (program must end with 'ret')
   319                                  
   320                                  ;	call os_clear_screen		; When finished, clear screen
   321                                  ;	jmp app_selector		; and go back to the program list
   322                                  
   323                                  
   324                                  ;no_kernel_execute:			; Warn about trying to executing kernel!
   325                                  ;	mov ax, kerndlg_string_1
   326                                  ;	mov bx, kerndlg_string_2
   327                                  ;	mov cx, kerndlg_string_3
   328                                  ;	mov dx, 0			; One button for dialog box
   329                                  ;	call os_dialog_box
   330                                  
   331                                  ;	jmp app_selector		; Start over again...
   332                                  
   333                                  
   334                                  ;not_bin_extension:
   335                                  ;	pop si				; We pushed during the .BIN extension check
   336                                  
   337                                  ;	push si				; Save it again in case of error...
   338                                  
   339                                  ;	mov bx, si
   340                                  ;	mov ax, si
   341                                  ;	call os_string_length
   342                                  
   343                                  ;	mov si, bx
   344                                  ;	add si, ax			; SI now points to end of filename...
   345                                  
   346                                  ;	dec si
   347                                  ;	dec si
   348                                  ;	dec si				; ...and now to start of extension!
   349                                  
   350                                  ;	mov di, bas_ext
   351                                  ;	mov cx, 3
   352                                  ;	rep cmpsb			; Are final 3 chars 'BAS'?
   353                                  ;	jne not_bas_extension		; If not, error out
   354                                  
   355                                  
   356                                  ;	pop si
   357                                  
   358                                  ;	mov ax, si
   359                                  ;	mov cx, 32768			; Where to load the program file
   360                                  ;	call os_load_file		; Load filename pointed to by AX
   361                                  ;
   362                                  ;	call os_clear_screen		; Clear screen before running
   363                                  ;
   364                                  ;	mov ax, 32768
   365                                  ;	mov si, 0			; No params to pass
   366                                  ;	call os_run_basic		; And run our BASIC interpreter on the code!
   367                                  ;
   368                                  ;	mov si, basic_finished_msg
   369                                  ;	call os_print_string
   370                                  ;	call os_wait_for_key
   371                                  ;
   372                                  ;	call os_clear_screen
   373                                  ;	jmp app_selector		; and go back to the program list
   374                                  ;
   375                                  ;
   376                                  ;not_bas_extension:
   377                                  ;	pop si
   378                                  
   379                                  ;	mov ax, ext_string_1
   380                                  ;	mov bx, ext_string_2
   381                                  ;	mov cx, 0
   382                                  ;	mov dx, 0			; One button for dialog box
   383                                  ;	call os_dialog_box
   384                                  ;
   385                                  ;	jmp app_selector		; Start over again...
   386                                  ;
   387                                  ;
   388                                  ;	; And now data for the above code...
   389                                  ;
   390                                  ;	kern_file_name		db 'KERNEL.BIN', 0
   391                                  ;
   392                                  ;	autorun_bin_file_name	db 'AUTORUN.BIN', 0
   393                                  ;	autorun_bas_file_name	db 'AUTORUN.BAS', 0
   394                                  ;
   395                                  ;	bin_ext			db 'BIN'
   396                                  ;	bas_ext			db 'BAS'
   397                                  ;
   398                                  ;	kerndlg_string_1	db 'Cannot load and execute MikeOS kernel!', 0
   399                                  ;	kerndlg_string_2	db 'KERNEL.BIN is the core of MikeOS, and', 0
   400                                  ;	kerndlg_string_3	db 'is not a normal program.', 0
   401                                  ;
   402                                  ;	ext_string_1		db 'Invalid filename extension! You can', 0
   403                                  ;	ext_string_2		db 'only execute .BIN or .BAS programs.', 0
   404                                  ;
   405                                  ;	basic_finished_msg	db '>>> BASIC program finished -- press a key', 0
   406                                  
   407                                  
   408                                  ; ------------------------------------------------------------------
   409                                  ; SYSTEM VARIABLES -- Settings for programs and system calls
   410                                  
   411                                  
   412                                  	; Time and date formatting
   413                                  
   414 0000009D 00                      	fmt_12_24	db 0		; Non-zero = 24-hr format
   415                                  
   416 0000009E 002F                    	fmt_date	db 0, '/'	; 0, 1, 2 = M/D/Y, D/M/Y or Y/M/D
   417                                  					; Bit 7 = use name for months
   418                                  					; If bit 7 = 0, second byte = separator character
   419 000000A0 0200                            Sides dw 2
   420 000000A2 1200                            SecsPerTrack dw 18
   421                                  ; ******************************************************************
   422 000000A4 00                              bootdev db 0                    ; Boot device number
   423                                  ; ******************************************************************
   424                                  
   425                                  ; ------------------------------------------------------------------
   426                                  ; FEATURES -- Code to pull into the kernel
   427                                  
   428                                  
   429                                  ;	%INCLUDE "features/cli.asm"
   430                                  ; 	%INCLUDE "features/disk.asm"
   431                                  ;	%INCLUDE "features/keyboard.asm"
   432                                  ;	%INCLUDE "features/math.asm"
   433                                  ;	%INCLUDE "features/misc.asm"
   434                                  ;	%INCLUDE "features/ports.asm"
   435                                  ;	%INCLUDE "features/screen.asm"
   436                                  ;	%INCLUDE "features/sound.asm"
   437                                  ;	%INCLUDE "features/string.asm"
   438                                  ;	%INCLUDE "features/basic.asm"
   439                                  
   440                                  
   441                                  ; ==================================================================
   442                                  ; END OF KERNEL
   443                                  ; ==================================================================
   444                                  
