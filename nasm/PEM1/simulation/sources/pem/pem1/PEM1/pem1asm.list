     1                                  ;Name:          pem1asm.asm
     2                                  ;Build:         see makefile
     3                                  ;Run:           ./pem1asm sourcefile -o binaryfile
     4                                  ;description:   Simple assembler for PEM1
     5                                  ;               -o creates binary file for PEM1 program.  This program cannot be run from any commandline!
     6                                  
     7                                  BITS 64
     8                                  
   839                                  [list -]
   840                                  
   841                                  ; maximum argument count
   842                                  %define ARGC 4
   843                                  ; custom errors must begin with number -134
   844                                  %define ESHOWUSAGE 		-134
   845                                  %define EILEGALOPTION 	-135
   846                                  %define EFILEEXISTS		-136
   847                                  %define ENOTUSING		-137
   848                                  %define EILEGALCHAR		-138
   849                                  
   850                                  section .bss
   851 00000000 <res 00000008>              fdsource:           resq    1
   852 00000008 <res 00000008>              fddestination:      resq    1
   853 00000010 <res 00000008>              ptrSourceFile:      resq    1
   854 00000018 <res 00000008>              ptrDestinationFile: resq    1
   855 00000020 <res 00000001>              buffer: 			resb	1
   856                                      ; flags
   857 00000021 <res 00000008>              sourcelines:		resq	1
   858 00000029 <res 00000001>              ignoreLine:			resb	1
   859 0000002A <res 00000001>              firstCharInLine:	resb	1
   860                                      
   861                                  section .data
   862                                  ; the errors messages list
   863                                  errorList:
   864 00000000 [5004000000000000]-     	dq	EPERMerr,ENOENTerr,ESRCHerr,EINTRerr,EIOerr,ENXIOerr,E2BIGerr
   865 00000008 [6904000000000000]-
   866 00000010 [8404000000000000]-
   867 00000018 [9504000000000000]-
   868 00000020 [AE04000000000000]-
   869 00000028 [B904000000000000]-
   870 00000030 [D404000000000000] 
   871 00000038 [EC04000000000000]-     	dq	ENOEXECerr,EBADFerr,ECHILDerr,EAGAINerr,ENOMEMerr,EACCESerr
   872 00000040 [FF04000000000000]-
   873 00000048 [1005000000000000]-
   874 00000050 [2405000000000000]-
   875 00000058 [2F05000000000000]-
   876 00000060 [3E05000000000000] 
   877 00000068 [5105000000000000]-     	dq	EFAULTerr,ENOTBLKerr,EBUSYerr,EEXISTerr,EXDEVerr,ENODEVerr
   878 00000070 [5E05000000000000]-
   879 00000078 [7505000000000000]-
   880 00000080 [8E05000000000000]-
   881 00000088 [9B05000000000000]-
   882 00000090 [AE05000000000000] 
   883 00000098 [BE05000000000000]-     	dq	ENOTDIRerr,EISDIRerr,EINVALerr,ENFILEerr,EMFILEerr,ENOTTYerr
   884 000000A0 [CF05000000000000]-
   885 000000A8 [DF05000000000000]-
   886 000000B0 [F105000000000000]-
   887 000000B8 [0606000000000000]-
   888 000000C0 [1B06000000000000] 
   889 000000C8 [2D06000000000000]-     	dq	ETXTBSYerr,EFBIGerr,ENOSPCerr,ESPIPEerr,EROFSerr,EMLINKerr
   890 000000D0 [3D06000000000000]-
   891 000000D8 [4D06000000000000]-
   892 000000E0 [6606000000000000]-
   893 000000E8 [7406000000000000]-
   894 000000F0 [8B06000000000000] 
   895 000000F8 [9B06000000000000]-     	dq	EPIPEerr,EDOMerr,ERANGEerr,EDEADLKerr,ENAMETOOLONGerr,ENOLCKerr
   896 00000100 [A806000000000000]-
   897 00000108 [CD06000000000000]-
   898 00000110 [EC06000000000000]-
   899 00000118 [0B07000000000000]-
   900 00000120 [1F07000000000000] 
   901 00000128 [3A07000000000000]-     	dq	ENOSYSerr,ENOTEMPTYerr,ELOOPerr,EWOULDBLOCKerr,ENOMSGerr
   902 00000130 [5407000000000000]-
   903 00000138 [6907000000000000]-
   904 00000140 [8E07000000000000]-
   905 00000148 [A507000000000000] 
   906 00000150 [C107000000000000]-     	dq	EIDRMerr,ECHRNGerr,EL2NSYNCerr,EL3HLTerr,EL3RSTerr,ELNRNGerr
   907 00000158 [D507000000000000]-
   908 00000160 [F207000000000000]-
   909 00000168 [0C08000000000000]-
   910 00000170 [1C08000000000000]-
   911 00000178 [2B08000000000000] 
   912 00000180 [4508000000000000]-     	dq	EUNATCHerr,ENOCSIerr,EL2HLTerr,EBADEerr,EBADRerr,EXFULLerr
   913 00000188 [6308000000000000]-
   914 00000190 [7F08000000000000]-
   915 00000198 [8F08000000000000]-
   916 000001A0 [A108000000000000]-
   917 000001A8 [BD08000000000000] 
   918 000001B0 [CC08000000000000]-     	dq	ENOANOerr,EBADRQCerr,EBADSLTerr,EDEADLOCKerr,EBFONTerr,ENOSTRerr
   919 000001B8 [D608000000000000]-
   920 000001C0 [EC08000000000000]-
   921 000001C8 [FA08000000000000]-
   922 000001D0 [1909000000000000]-
   923 000001D8 [2F09000000000000] 
   924 000001E0 [4409000000000000]-     	dq	ENODATAerr,ETIMEerr,ENOSRerr,ENONETerr,ENOPKGerr,EREMOTEerr
   925 000001E8 [5709000000000000]-
   926 000001F0 [6609000000000000]-
   927 000001F8 [8009000000000000]-
   928 00000200 [9F09000000000000]-
   929 00000208 [B609000000000000] 
   930 00000210 [C809000000000000]-     	dq	ENOLINKerr,EADVerr,ESRMNTerr,ECOMMerr,EPROTOerr,EMULTIHOPerr
   931 00000218 [DF09000000000000]-
   932 00000220 [F009000000000000]-
   933 00000228 [FF09000000000000]-
   934 00000230 [1C0A000000000000]-
   935 00000238 [2C0A000000000000] 
   936 00000240 [400A000000000000]-     	dq	EDOTDOTerr,EBADMSGerr,EOVERFLOWerr,ENOTUNIQerr,EBADFDerr,EREMCHGerr
   937 00000248 [540A000000000000]-
   938 00000250 [680A000000000000]-
   939 00000258 [8F0A000000000000]-
   940 00000260 [AB0A000000000000]-
   941 00000268 [C90A000000000000] 
   942 00000270 [E10A000000000000]-     	dq	ELIBACCerr,ELIBBADerr,ELIBSCNerr,ELIBMAXerr,ELIBEXECerr,EILSEQerr
   943 00000278 [090B000000000000]-
   944 00000280 [2F0B000000000000]-
   945 00000288 [500B000000000000]-
   946 00000290 [810B000000000000]-
   947 00000298 [A80B000000000000] 
   948 000002A0 [BF0B000000000000]-     	dq	ERESTARTerr,ESTRPIPEerr,EUSERSerr,ENOTSOCKerr,EDESTADDRREQerr
   949 000002A8 [EC0B000000000000]-
   950 000002B0 [000C000000000000]-
   951 000002B8 [100C000000000000]-
   952 000002C0 [300C000000000000] 
   953 000002C8 [4E0C000000000000]-     	dq	EMSGSIZEerr,EPROTOTYPEerr,ENOPROTOOPTerr,EPROTONOSUPPORTerr
   954 000002D0 [600C000000000000]-
   955 000002D8 [800C000000000000]-
   956 000002E0 [980C000000000000] 
   957 000002E8 [B00C000000000000]-     	dq	ESOCKTNOSUPPORTerr,EOPNOTSUPPerr,EPFNOSUPPORTerr,EAFNOSUPPORTerr
   958 000002F0 [CB0C000000000000]-
   959 000002F8 [FA0C000000000000]-
   960 00000300 [190D000000000000] 
   961 00000308 [430D000000000000]-     	dq	EADDRINUSEerr,EADDRNOTAVAILerr,ENETDOWNerr,ENETUNREACHerr,ENETRESETerr
   962 00000310 [5B0D000000000000]-
   963 00000318 [7C0D000000000000]-
   964 00000320 [8D0D000000000000]-
   965 00000328 [A50D000000000000] 
   966 00000330 [D20D000000000000]-     	dq	ECONNABORTEDerr,ECONNRESETerr,ENOBUFSerr,EISCONNerr,ENOTCONNerr
   967 00000338 [F40D000000000000]-
   968 00000340 [0E0E000000000000]-
   969 00000348 [290E000000000000]-
   970 00000350 [520E000000000000] 
   971 00000358 [770E000000000000]-     	dq	ESHUTDOWNerr,ETOOMANYREFSerr,ETIMEDOUTerr,ECONNREFUSEDerr,EHOSTDOWNerr,
   972 00000360 [A60E000000000000]-
   973 00000368 [CA0E000000000000]-
   974 00000370 [E00E000000000000]-
   975 00000378 [F40E000000000000] 
   976 00000380 [020F000000000000]-     	dq	EHOSTUNREACHerr,EALREADYerr,EINPROGRESSerr,ESTALEerr,EUCLEANerr,
   977 00000388 [140F000000000000]-
   978 00000390 [330F000000000000]-
   979 00000398 [4E0F000000000000]-
   980 000003A0 [650F000000000000] 
   981 000003A8 [7F0F000000000000]-     	dq	ENOTNAMerr,ENAVAILerr,EISNAMerr,EREMOTEIOerr,EDQUOTerr,ENOMEDIUMerr
   982 000003B0 [9C0F000000000000]-
   983 000003B8 [BB0F000000000000]-
   984 000003C0 [D10F000000000000]-
   985 000003C8 [E30F000000000000]-
   986 000003D0 [F30F000000000000] 
   987 000003D8 [0410000000000000]-     	dq	EMEDIUMTYPEerr,ECANCELEDerr,ENOKEYerr,EKEYEXPIREDerr,EKEYREVOKEDerr
   988 000003E0 [1710000000000000]-
   989 000003E8 [2B10000000000000]-
   990 000003F0 [4710000000000000]-
   991 000003F8 [5810000000000000] 
   992 00000400 [6E10000000000000]-     	dq	EKEYREJECTEDerr,EOWNERDEADerr,ENOTRECOVERABLEerr,ERFKILLerr,EHWPOISONerr
   993 00000408 [8B10000000000000]-
   994 00000410 [9710000000000000]-
   995 00000418 [AE10000000000000]-
   996 00000420 [D510000000000000] 
   997                                  	; custom errors must begin with number -134
   998 00000428 [F510000000000000]-     	dq	ESHOWUSAGEerr,EILEGALOPTIONerr,EFILEEXISTSerr,ENOTUSINGerr,EILEGALCHARerr
   999 00000430 [1E11000000000000]-
  1000 00000438 [4A11000000000000]-
  1001 00000440 [6911000000000000]-
  1002 00000448 [A111000000000000] 
  1003                                  
  1004 00000450 4F7065726174696F6E-     	EPERMerr:			db	EPERMmsg,10,0
  1005 00000459 206E6F74207065726D-
  1006 00000462 69747465640A00     
  1007 00000469 4E6F20737563682066-     	ENOENTerr:			db	ENOENTmsg,10,0
  1008 00000472 696C65206F72206469-
  1009 0000047B 726563746F72790A00 
  1010 00000484 4E6F20737563682070-     	ESRCHerr:			db	ESRCHmsg,10,0
  1011 0000048D 726F636573730A00   
  1012 00000495 496E74657272757074-     	EINTRerr:			db	EINTRmsg,10,0
  1013 0000049E 65642073797374656D-
  1014 000004A7 2063616C6C0A00     
  1015 000004AE 492F4F206572726F72-     	EIOerr:				db	EIOmsg,10,0
  1016 000004B7 0A00               
  1017 000004B9 4E6F20737563682064-     	ENXIOerr:			db	ENXIOmsg,10,0
  1018 000004C2 6576696365206F7220-
  1019 000004CB 616464726573730A00 
  1020 000004D4 417267756D656E7420-     	E2BIGerr:			db	E2BIGmsg,10,0
  1021 000004DD 6C69737420746F6F20-
  1022 000004E6 6C6F6E670A00       
  1023 000004EC 4578656320666F726D-     	ENOEXECerr:			db	ENOEXECmsg,10,0
  1024 000004F5 6174206572726F720A-
  1025 000004FE 00                 
  1026 000004FF 4261642066696C6520-     	EBADFerr:			db	EBADFmsg,10,0
  1027 00000508 6E756D6265720A00   
  1028 00000510 4E6F206368696C6420-     	ECHILDerr:			db	ECHILDmsg,10,0
  1029 00000519 70726F636573736573-
  1030 00000522 0A00               
  1031 00000524 54727920616761696E-     	EAGAINerr:			db	EAGAINmsg,10,0
  1032 0000052D 0A00               
  1033 0000052F 4F7574206F66206D65-     	ENOMEMerr:			db	ENOMEMmsg,10,0
  1034 00000538 6D6F72790A00       
  1035 0000053E 5065726D697373696F-     	EACCESerr:			db	EACCESmsg,10,0
  1036 00000547 6E2064656E6965640A-
  1037 00000550 00                 
  1038 00000551 426164206164647265-     	EFAULTerr:			db	EFAULTmsg,10,0
  1039 0000055A 73730A00           
  1040 0000055E 426C6F636B20646576-     	ENOTBLKerr:			db	ENOTBLKmsg,10,0
  1041 00000567 696365207265717569-
  1042 00000570 7265640A00         
  1043 00000575 446576696365206F72-     	EBUSYerr:			db	EBUSYmsg,10,0
  1044 0000057E 207265736F75726365-
  1045 00000587 20627573790A00     
  1046 0000058E 46696C652065786973-     	EEXISTerr:			db	EEXISTmsg,10,0
  1047 00000597 74730A00           
  1048 0000059B 43726F73732D646576-     	EXDEVerr:			db	EXDEVmsg,10,0
  1049 000005A4 696365206C696E6B0A-
  1050 000005AD 00                 
  1051 000005AE 4E6F20737563682064-     	ENODEVerr:			db	ENODEVmsg,10,0
  1052 000005B7 65766963650A00     
  1053 000005BE 4E6F74206120646972-     	ENOTDIRerr:			db	ENOTDIRmsg,10,0
  1054 000005C7 6563746F72790A00   
  1055 000005CF 497320612064697265-     	EISDIRerr:			db	EISDIRmsg,10,0
  1056 000005D8 63746F72790A00     
  1057 000005DF 496E76616C69642061-     	EINVALerr:			db	EINVALmsg,10,0
  1058 000005E8 7267756D656E740A00 
  1059 000005F1 46696C65207461626C-     	ENFILEerr:			db	ENFILEmsg,10,0
  1060 000005FA 65206F766572666C6F-
  1061 00000603 770A00             
  1062 00000606 546F6F206D616E7920-     	EMFILEerr:			db	EMFILEmsg,10,0
  1063 0000060F 6F70656E2066696C65-
  1064 00000618 730A00             
  1065 0000061B 4E6F74206120747970-     	ENOTTYerr:			db	ENOTTYmsg,10,0
  1066 00000624 657772697465720A00 
  1067 0000062D 546578742066696C65-     	ETXTBSYerr:			db	ETXTBSYmsg,10,0
  1068 00000636 20627573790A00     
  1069 0000063D 46696C6520746F6F20-     	EFBIGerr:			db	EFBIGmsg,10,0
  1070 00000646 6C617267650A00     
  1071 0000064D 4E6F20737061636520-     	ENOSPCerr:			db	ENOSPCmsg,10,0
  1072 00000656 6C656674206F6E2064-
  1073 0000065F 65766963650A00     
  1074 00000666 496C6C6567616C2073-     	ESPIPEerr:			db	ESPIPEmsg,10,0
  1075 0000066F 65656B0A00         
  1076 00000674 526561642D6F6E6C79-     	EROFSerr:			db	EROFSmsg,10,0
  1077 0000067D 2066696C6520737973-
  1078 00000686 74656D0A00         
  1079 0000068B 546F6F206D616E7920-     	EMLINKerr:			db	EMLINKmsg,10,0
  1080 00000694 6C696E6B730A00     
  1081 0000069B 42726F6B656E207069-     	EPIPEerr:			db	EPIPEmsg,10,0
  1082 000006A4 70650A00           
  1083 000006A8 4D6174682061726775-     	EDOMerr:			db	EDOMmsg,10,0
  1084 000006B1 6D656E74206F757420-
  1085 000006BA 6F6620646F6D61696E-
  1086 000006C3 206F662066756E630A-
  1087 000006CC 00                 
  1088 000006CD 4D6174682072657375-     	ERANGEerr:			db	ERANGEmsg,10,0
  1089 000006D6 6C74206E6F74207265-
  1090 000006DF 70726573656E746162-
  1091 000006E8 6C650A00           
  1092 000006EC 5265736F7572636520-     	EDEADLKerr:			db	EDEADLKmsg,10,0
  1093 000006F5 646561646C6F636B20-
  1094 000006FE 776F756C64206F6363-
  1095 00000707 75720A00           
  1096 0000070B 46696C65206E616D65-     	ENAMETOOLONGerr:	db	ENAMETOOLONGmsg,10,0
  1097 00000714 20746F6F206C6F6E67-
  1098 0000071D 0A00               
  1099 0000071F 4E6F207265636F7264-     	ENOLCKerr:			db	ENOLCKmsg,10,0
  1100 00000728 206C6F636B73206176-
  1101 00000731 61696C61626C650A00 
  1102 0000073A 46756E6374696F6E20-     	ENOSYSerr:			db	ENOSYSmsg,10,0
  1103 00000743 6E6F7420696D706C65-
  1104 0000074C 6D656E7465640A00   
  1105 00000754 4469726563746F7279-     	ENOTEMPTYerr:		db	ENOTEMPTYmsg,10,0
  1106 0000075D 206E6F7420656D7074-
  1107 00000766 790A00             
  1108 00000769 546F6F206D616E7920-     	ELOOPerr:			db	ELOOPmsg,10,0
  1109 00000772 73796D626F6C696320-
  1110 0000077B 6C696E6B7320656E63-
  1111 00000784 6F756E74657265640A-
  1112 0000078D 00                 
  1113 0000078E 4F7065726174696F6E-     	EWOULDBLOCKerr:		db	EWOULDBLOCKmsg,10,0
  1114 00000797 20776F756C6420626C-
  1115 000007A0 6F636B0A00         
  1116 000007A5 4E6F206D6573736167-     	ENOMSGerr:			db	ENOMSGmsg,10,0
  1117 000007AE 65206F662064657369-
  1118 000007B7 72656420747970650A-
  1119 000007C0 00                 
  1120 000007C1 4964656E7469666965-     	EIDRMerr:			db	EIDRMmsg,10,0
  1121 000007CA 722072656D6F766564-
  1122 000007D3 0A00               
  1123 000007D5 4368616E6E656C206E-     	ECHRNGerr:			db	ECHRNGmsg,10,0
  1124 000007DE 756D626572206F7574-
  1125 000007E7 206F662072616E6765-
  1126 000007F0 0A00               
  1127 000007F2 4C6576656C2032206E-     	EL2NSYNCerr:		db	EL2NSYNCmsg,10,0
  1128 000007FB 6F742073796E636872-
  1129 00000804 6F6E697A65640A00   
  1130 0000080C 4C6576656C20332068-     	EL3HLTerr:			db	EL3HLTmsg,10,0
  1131 00000815 616C7465640A00     
  1132 0000081C 4C6576656C20332072-     	EL3RSTerr:			db	EL3RSTmsg,10,0
  1133 00000825 657365740A00       
  1134 0000082B 4C696E6B206E756D62-     	ELNRNGerr:			db	ELNRNGmsg,10,0
  1135 00000834 6572206F7574206F66-
  1136 0000083D 2072616E67650A00   
  1137 00000845 50726F746F636F6C20-     	EUNATCHerr:			db	EUNATCHmsg,10,0
  1138 0000084E 647269766572206E6F-
  1139 00000857 742061747461636865-
  1140 00000860 640A00             
  1141 00000863 4E6F20435349207374-     	ENOCSIerr:			db	ENOCSImsg,10,0
  1142 0000086C 727563747572652061-
  1143 00000875 7661696C61626C650A-
  1144 0000087E 00                 
  1145 0000087F 4C6576656C20322068-     	EL2HLTerr:			db	EL2HLTmsg,10,0
  1146 00000888 616C7465640A00     
  1147 0000088F 496E76616C69642065-     	EBADEerr:			db	EBADEmsg,10,0
  1148 00000898 786368616E67650A00 
  1149 000008A1 496E76616C69642072-     	EBADRerr:			db	EBADRmsg,10,0
  1150 000008AA 657175657374206465-
  1151 000008B3 7363726970746F720A-
  1152 000008BC 00                 
  1153 000008BD 45786368616E676520-     	EXFULLerr:			db	EXFULLmsg,10,0
  1154 000008C6 66756C6C0A00       
  1155 000008CC 4E6F20616E6F64650A-     	ENOANOerr:			db	ENOANOmsg,10,0
  1156 000008D5 00                 
  1157 000008D6 496E76616C69642072-     	EBADRQCerr:			db	EBADRQCmsg,10,0
  1158 000008DF 65717565737420636F-
  1159 000008E8 64650A00           
  1160 000008EC 496E76616C69642073-     	EBADSLTerr:			db	EBADSLTmsg,10,0
  1161 000008F5 6C6F740A00         
  1162 000008FA 5265736F7572636520-     	EDEADLOCKerr:		db	EDEADLOCKmsg,10,0
  1163 00000903 646561646C6F636B20-
  1164 0000090C 776F756C64206F6363-
  1165 00000915 75720A00           
  1166 00000919 42616420666F6E7420-     	EBFONTerr:			db	EBFONTmsg,10,0
  1167 00000922 66696C6520666F726D-
  1168 0000092B 61740A00           
  1169 0000092F 446576696365206E6F-     	ENOSTRerr:			db	ENOSTRmsg,10,0
  1170 00000938 742061207374726561-
  1171 00000941 6D0A00             
  1172 00000944 4E6F20646174612061-     	ENODATAerr:			db	ENODATAmsg,10,0
  1173 0000094D 7661696C61626C650A-
  1174 00000956 00                 
  1175 00000957 54696D657220657870-     	ETIMEerr:			db	ETIMEmsg,10,0
  1176 00000960 697265640A00       
  1177 00000966 4F7574206F66207374-     	ENOSRerr:			db	ENOSRmsg,10,0
  1178 0000096F 7265616D7320726573-
  1179 00000978 6F75726365730A00   
  1180 00000980 4D616368696E652069-     	ENONETerr:			db	ENONETmsg,10,0
  1181 00000989 73206E6F74206F6E20-
  1182 00000992 746865206E6574776F-
  1183 0000099B 726B0A00           
  1184 0000099F 5061636B616765206E-     	ENOPKGerr:			db	ENOPKGmsg,10,0
  1185 000009A8 6F7420696E7374616C-
  1186 000009B1 6C65640A00         
  1187 000009B6 4F626A656374206973-     	EREMOTEerr:			db	EREMOTEmsg,10,0
  1188 000009BF 2072656D6F74650A00 
  1189 000009C8 4C696E6B2068617320-     	ENOLINKerr:			db	ENOLINKmsg,10,0
  1190 000009D1 6265656E2073657665-
  1191 000009DA 7265640A00         
  1192 000009DF 416476657274697365-     	EADVerr:			db	EADVmsg,10,0
  1193 000009E8 206572726F720A00   
  1194 000009F0 53726D6F756E742065-     	ESRMNTerr:			db	ESRMNTmsg,10,0
  1195 000009F9 72726F720A00       
  1196 000009FF 436F6D6D756E696361-     	ECOMMerr:			db	ECOMMmsg,10,0
  1197 00000A08 74696F6E206572726F-
  1198 00000A11 72206F6E2073656E64-
  1199 00000A1A 0A00               
  1200 00000A1C 50726F746F636F6C20-     	EPROTOerr:			db	EPROTOmsg,10,0
  1201 00000A25 6572726F720A00     
  1202 00000A2C 4D756C7469686F7020-     	EMULTIHOPerr:		db	EMULTIHOPmsg,10,0
  1203 00000A35 617474656D70746564-
  1204 00000A3E 0A00               
  1205 00000A40 524653207370656369-     	EDOTDOTerr:			db	EDOTDOTmsg,10,0
  1206 00000A49 666963206572726F72-
  1207 00000A52 0A00               
  1208 00000A54 4E6F74206120646174-     	EBADMSGerr:			db	EBADMSG,10,0
  1209 00000A5D 61206D657373616765-
  1210 00000A66 0A00               
  1211 00000A68 56616C756520746F6F-     	EOVERFLOWerr:		db	EOVERFLOWmsg,10,0
  1212 00000A71 206C6172676520666F-
  1213 00000A7A 7220646566696E6564-
  1214 00000A83 206461746120747970-
  1215 00000A8C 650A00             
  1216 00000A8F 4E616D65206E6F7420-     	ENOTUNIQerr:		db	ENOTUNIQmsg,10,0
  1217 00000A98 756E69717565206F6E-
  1218 00000AA1 206E6574776F726B0A-
  1219 00000AAA 00                 
  1220 00000AAB 46696C652064657363-     	EBADFDerr:			db	EBADFDmsg,10,0
  1221 00000AB4 726970746F7220696E-
  1222 00000ABD 206261642073746174-
  1223 00000AC6 650A00             
  1224 00000AC9 52656D6F7465206164-     	EREMCHGerr:			db	EREMCHGmsg,10,0
  1225 00000AD2 647265737320636861-
  1226 00000ADB 6E6765640A00       
  1227 00000AE1 43616E206E6F742061-     	ELIBACCerr:			db	ELIBACCmsg,10,0
  1228 00000AEA 63636573732061206E-
  1229 00000AF3 656564656420736861-
  1230 00000AFC 726564206C69627261-
  1231 00000B05 72790A00           
  1232 00000B09 416363657373696E67-     	ELIBBADerr:			db	ELIBBADmsg,10,0
  1233 00000B12 206120636F72727570-
  1234 00000B1B 746564207368617265-
  1235 00000B24 64206C696272617279-
  1236 00000B2D 0A00               
  1237 00000B2F 2E6C69622073656374-     	ELIBSCNerr:			db	ELIBSCNmsg,10,0
  1238 00000B38 696F6E20696E20612E-
  1239 00000B41 6F757420636F727275-
  1240 00000B4A 707465640A00       
  1241 00000B50 417474656D7074696E-     	ELIBMAXerr:			db	ELIBMAXmsg,10,0
  1242 00000B59 6720746F206C696E6B-
  1243 00000B62 20696E20746F6F206D-
  1244 00000B6B 616E79207368617265-
  1245 00000B74 64206C696272617269-
  1246 00000B7D 65730A00           
  1247 00000B81 43616E6E6F74206578-     	ELIBEXECerr:		db	ELIBEXECmsg,10,0
  1248 00000B8A 656320612073686172-
  1249 00000B93 6564206C6962726172-
  1250 00000B9C 79206469726563746C-
  1251 00000BA5 790A00             
  1252 00000BA8 496C6C6567616C2062-     	EILSEQerr:			db	EILSEQmsg,10,0
  1253 00000BB1 797465207365717565-
  1254 00000BBA 6E63650A00         
  1255 00000BBF 496E74657272757074-     	ERESTARTerr:		db	ERESTARTmsg,10,0
  1256 00000BC8 65642073797374656D-
  1257 00000BD1 2063616C6C2073686F-
  1258 00000BDA 756C64206265207265-
  1259 00000BE3 737461727465640A00 
  1260 00000BEC 53747265616D732070-     	ESTRPIPEerr:		db	ESTRPIPEmsg,10,0
  1261 00000BF5 697065206572726F72-
  1262 00000BFE 0A00               
  1263 00000C00 546F6F206D616E7920-     	EUSERSerr:			db	EUSERSmsg,10,0
  1264 00000C09 75736572730A00     
  1265 00000C10 536F636B6574206F70-     	ENOTSOCKerr:		db	ENOTSOCKmsg,10,0
  1266 00000C19 65726174696F6E206F-
  1267 00000C22 6E206E6F6E2D736F63-
  1268 00000C2B 6B65740A00         
  1269 00000C30 44657374696E617469-     	EDESTADDRREQerr:	db	EDESTADDRREQmsg,10,0
  1270 00000C39 6F6E20616464726573-
  1271 00000C42 732072657175697265-
  1272 00000C4B 640A00             
  1273 00000C4E 4D6573736167652074-     	EMSGSIZEerr:		db	EMSGSIZEmsg,10,0
  1274 00000C57 6F6F206C6F6E670A00 
  1275 00000C60 50726F746F636F6C20-     	EPROTOTYPEerr:		db	EPROTOTYPEmsg,10,0
  1276 00000C69 77726F6E6720747970-
  1277 00000C72 6520666F7220736F63-
  1278 00000C7B 6B65740A00         
  1279 00000C80 50726F746F636F6C20-     	ENOPROTOOPTerr:		db	ENOPROTOOPTmsg,10,0
  1280 00000C89 6E6F7420617661696C-
  1281 00000C92 61626C650A00       
  1282 00000C98 50726F746F636F6C20-     	EPROTONOSUPPORTerr:	db	EPROTONOSUPPORTmsg,10,0
  1283 00000CA1 6E6F7420737570706F-
  1284 00000CAA 727465640A00       
  1285 00000CB0 536F636B6574207479-     	ESOCKTNOSUPPORTerr:	db	ESOCKTNOSUPPORTmsg,10,0
  1286 00000CB9 7065206E6F74207375-
  1287 00000CC2 70706F727465640A00 
  1288 00000CCB 4F7065726174696F6E-     	EOPNOTSUPPerr:		db	EOPNOTSUPPmsg,10,0
  1289 00000CD4 206E6F742073757070-
  1290 00000CDD 6F72746564206F6E20-
  1291 00000CE6 7472616E73706F7274-
  1292 00000CEF 20656E64706F696E74-
  1293 00000CF8 0A00               
  1294 00000CFA 50726F746F636F6C20-     	EPFNOSUPPORTerr:	db	EPFNOSUPPORTmsg,10,0
  1295 00000D03 66616D696C79206E6F-
  1296 00000D0C 7420737570706F7274-
  1297 00000D15 65640A00           
  1298 00000D19 416464726573732066-     	EAFNOSUPPORTerr:	db	EAFNOSUPPORTmsg,10,0
  1299 00000D22 616D696C79206E6F74-
  1300 00000D2B 20737570706F727465-
  1301 00000D34 642062792070726F74-
  1302 00000D3D 6F636F6C0A00       
  1303 00000D43 416464726573732061-     	EADDRINUSEerr:		db	EADDRINUSEmsg,10,0
  1304 00000D4C 6C726561647920696E-
  1305 00000D55 207573650A00       
  1306 00000D5B 43616E6E6F74206173-     	EADDRNOTAVAILerr:	db	EADDRNOTAVAILmsg,10,0
  1307 00000D64 7369676E2072657175-
  1308 00000D6D 657374656420616464-
  1309 00000D76 726573730A00       
  1310 00000D7C 4E6574776F726B2069-     	ENETDOWNerr:		db	ENETDOWNmsg,10,0
  1311 00000D85 7320646F776E0A00   
  1312 00000D8D 4E6574776F726B2069-     	ENETUNREACHerr:		db	ENETUNREACHmsg,10,0
  1313 00000D96 7320756E7265616368-
  1314 00000D9F 61626C650A00       
  1315 00000DA5 4E6574776F726B2064-     	ENETRESETerr:		db	ENETRESETmsg,10,0
  1316 00000DAE 726F7070656420636F-
  1317 00000DB7 6E6E656374696F6E20-
  1318 00000DC0 62656361757365206F-
  1319 00000DC9 662072657365740A00 
  1320 00000DD2 536F66747761726520-     	ECONNABORTEDerr:	db	ECONNABORTEDmsg,10,0
  1321 00000DDB 63617573656420636F-
  1322 00000DE4 6E6E656374696F6E20-
  1323 00000DED 61626F72740A00     
  1324 00000DF4 436F6E6E656374696F-     	ECONNRESETerr:		db	ECONNRESETmsg,10,0
  1325 00000DFD 6E2072657365742062-
  1326 00000E06 7920706565720A00   
  1327 00000E0E 4E6F20627566666572-     	ENOBUFSerr:			db	ENOBUFSmsg,10,0
  1328 00000E17 207370616365206176-
  1329 00000E20 61696C61626C650A00 
  1330 00000E29 5472616E73706F7274-     	EISCONNerr:			db	EISCONNmsg,10,0
  1331 00000E32 20656E64706F696E74-
  1332 00000E3B 20697320616C726561-
  1333 00000E44 647920636F6E6E6563-
  1334 00000E4D 7465640A00         
  1335 00000E52 5472616E73706F7274-     	ENOTCONNerr:		db	ENOTCONNmsg,10,0
  1336 00000E5B 20656E64706F696E74-
  1337 00000E64 206973206E6F742063-
  1338 00000E6D 6F6E6E65637465640A-
  1339 00000E76 00                 
  1340 00000E77 43616E6E6F74207365-     	ESHUTDOWNerr:		db	ESHUTDOWNmsg,10,0
  1341 00000E80 6E6420616674657220-
  1342 00000E89 7472616E73706F7274-
  1343 00000E92 20656E64706F696E74-
  1344 00000E9B 2073687574646F776E-
  1345 00000EA4 0A00               
  1346 00000EA6 546F6F206D616E7920-     	ETOOMANYREFSerr:	db	ETOOMANYREFSmsg,10,0
  1347 00000EAF 7265666572656E6365-
  1348 00000EB8 733A2063616E6E6F74-
  1349 00000EC1 2073706C6963650A00 
  1350 00000ECA 436F6E6E656374696F-     	ETIMEDOUTerr:		db	ETIMEDOUTmsg,10,0
  1351 00000ED3 6E2074696D6564206F-
  1352 00000EDC 75740A00           
  1353 00000EE0 436F6E6E656374696F-     	ECONNREFUSEDerr:	db	ECONNREFUSEDmsg,10,0
  1354 00000EE9 6E2072656675736564-
  1355 00000EF2 0A00               
  1356 00000EF4 486F73742069732064-     	EHOSTDOWNerr:		db	EHOSTDOWNmsg,10,0
  1357 00000EFD 6F776E0A00         
  1358 00000F02 4E6F20726F75746520-     	EHOSTUNREACHerr:	db	EHOSTUNREACHmsg,10,0
  1359 00000F0B 746F20686F73740A00 
  1360 00000F14 4F7065726174696F6E-     	EALREADYerr:		db	EALREADYmsg,10,0
  1361 00000F1D 20616C726561647920-
  1362 00000F26 696E2070726F677265-
  1363 00000F2F 73730A00           
  1364 00000F33 4F7065726174696F6E-     	EINPROGRESSerr:		db	EINPROGRESSmsg,10,0
  1365 00000F3C 206E6F7720696E2070-
  1366 00000F45 726F67726573730A00 
  1367 00000F4E 5374616C65204E4653-     	ESTALEerr:			db	ESTALEmsg,10,0
  1368 00000F57 2066696C652068616E-
  1369 00000F60 646C650A00         
  1370 00000F65 537472756374757265-     	EUCLEANerr:			db	EUCLEANmsg,10,0
  1371 00000F6E 206E6565647320636C-
  1372 00000F77 65616E696E670A00   
  1373 00000F7F 4E6F7420612058454E-     	ENOTNAMerr:			db	ENOTNAMmsg,10,0
  1374 00000F88 4958206E616D656420-
  1375 00000F91 747970652066696C65-
  1376 00000F9A 0A00               
  1377 00000F9C 4E6F2058454E495820-     	ENAVAILerr:			db	ENAVAILmsg,10,0
  1378 00000FA5 73656D6170686F7265-
  1379 00000FAE 7320617661696C6162-
  1380 00000FB7 6C650A00           
  1381 00000FBB 49732061206E616D65-     	EISNAMerr:			db	EISNAMmsg,10,0
  1382 00000FC4 642074797065206669-
  1383 00000FCD 6C650A00           
  1384 00000FD1 52656D6F746520492F-     	EREMOTEIOerr:		db	EREMOTEIOmsg,10,0
  1385 00000FDA 4F206572726F720A00 
  1386 00000FE3 51756F746120657863-     	EDQUOTerr:			db	EDQUOTmsg,10,0
  1387 00000FEC 65656465640A00     
  1388 00000FF3 4E6F206D656469756D-     	ENOMEDIUMerr:		db	ENOMEDIUMmsg,10,0
  1389 00000FFC 20666F756E640A00   
  1390 00001004 57726F6E67206D6564-     	EMEDIUMTYPEerr:		db	EMEDIUMTYPEmsg,10,0
  1391 0000100D 69756D20747970650A-
  1392 00001016 00                 
  1393 00001017 4F7065726174696F6E-     	ECANCELEDerr:		db	ECANCELEDmsg,10,0
  1394 00001020 2043616E63656C6564-
  1395 00001029 0A00               
  1396 0000102B 526571756972656420-     	ENOKEYerr:			db	ENOKEYmsg,10,0
  1397 00001034 6B6579206E6F742061-
  1398 0000103D 7661696C61626C650A-
  1399 00001046 00                 
  1400 00001047 4B6579206861732065-     	EKEYEXPIREDerr:		db	EKEYEXPIREDmsg,10,0
  1401 00001050 7870697265640A00   
  1402 00001058 4B6579206861732062-     	EKEYREVOKEDerr:		db	EKEYREVOKEDmsg,10,0
  1403 00001061 65656E207265766F6B-
  1404 0000106A 65640A00           
  1405 0000106E 4B6579207761732072-     	EKEYREJECTEDerr:	db	EKEYREJECTEDmsg,10,0
  1406 00001077 656A65637465642062-
  1407 00001080 792073657276696365-
  1408 00001089 0A00               
  1409 0000108B 4F776E657220646965-     	EOWNERDEADerr:		db	EOWNERDEADmsg,10,0
  1410 00001094 640A00             
  1411 00001097 5374617465206E6F74-     	ENOTRECOVERABLEerr:	db	ENOTRECOVERABLEmsg,10,0
  1412 000010A0 207265636F76657261-
  1413 000010A9 626C650A00         
  1414 000010AE 4F7065726174696F6E-     	ERFKILLerr:			db	ERFKILLmsg,10,0
  1415 000010B7 206E6F7420706F7373-
  1416 000010C0 69626C652064756520-
  1417 000010C9 746F2052462D6B696C-
  1418 000010D2 6C0A00             
  1419 000010D5 4D656D6F7279207061-     	EHWPOISONerr:		db	EHWPOISONmsg,10,0
  1420 000010DE 676520686173206861-
  1421 000010E7 726477617265206572-
  1422 000010F0 726F720A00         
  1423                                  	; custom error messages
  1424 000010F5 75736167653A207065-         ESHOWUSAGEerr:      db  "usage: pem1asm sourcefile -o binaryfile",10,0
  1425 000010FE 6D3161736D20736F75-
  1426 00001107 72636566696C65202D-
  1427 00001110 6F2062696E61727966-
  1428 00001119 696C650A00         
  1429 0000111E 696C6567616C206F70-         EILEGALOPTIONerr:	db	"ilegal option, use -o for destination file",10,0
  1430 00001127 74696F6E2C20757365-
  1431 00001130 202D6F20666F722064-
  1432 00001139 657374696E6174696F-
  1433 00001142 6E2066696C650A00   
  1434 0000114A 46696C652065786973-         EFILEEXISTSerr:		db  "File exists, overwrite? [Y/n] ",0
  1435 00001153 74732C206F76657277-
  1436 0000115C 726974653F205B592F-
  1437 00001165 6E5D2000           
  1438 00001169 4E6F74207573696E67-         ENOTUSINGerr:		db	"Not using destination file name as requested, exiting.",10,0
  1439 00001172 2064657374696E6174-
  1440 0000117B 696F6E2066696C6520-
  1441 00001184 6E616D652061732072-
  1442 0000118D 65717565737465642C-
  1443 00001196 2065786974696E672E-
  1444 0000119F 0A00               
  1445 000011A1 2D20496C6567616C20-         EILEGALCHARerr:		db	"- Ilegal character in source!",10,0
  1446 000011AA 636861726163746572-
  1447 000011B3 20696E20736F757263-
  1448 000011BC 65210A00           
  1449                                      
  1450 000011C0 3A20                        COLONmsg:			db	": "
  1451                                      COLONmsg.length:	equ	$-COLONmsg
  1452 000011C2 0A                          CRLFmsg:			db	10
  1453                                      CRLFmsg.length:		equ $-CRLFmsg
  1454                                      
  1455 000011C3 544553542042494E41-         binary:             db	"TEST BINARY FILE",10
  1456 000011CC 52592046494C450A   
  1457                                      binary.length:		equ		$-binary
  1458                                          
  1459                                      ; stat structure
  1460                                      STAT stat
  1461                              <1>  %1: ISTRUC STAT_STRUC
  1462 000011D4 0000000000000000    <1>  at STAT_STRUC.st_dev, dq 0
  1463 000011DC 0000000000000000    <1>  at STAT_STRUC.st_ino, dq 0
  1464 000011E4 0000000000000000    <1>  at STAT_STRUC.st_nlink, dq 0
  1465 000011EC 00000000            <1>  at STAT_STRUC.st_mod, dd 0
  1466 000011F0 00000000            <1>  at STAT_STRUC.st_uid, dd 0
  1467 000011F4 00000000            <1>  at STAT_STRUC.st_gid, dd 0
  1468 000011F8 0000000000000000    <1>  at STAT_STRUC.st_rdev, dq 0
  1469 00001200 00000000            <1>  at STAT_STRUC._pad1, dd 0
  1470 00001204 0000000000000000    <1>  at STAT_STRUC.st_size, dq 0
  1471 0000120C 00000000            <1>  at STAT_STRUC.st_blksize, dd 0
  1472 00001210 00000000            <1>  at STAT_STRUC._pad2, dd 0
  1473 00001214 0000000000000000    <1>  at STAT_STRUC.st_blocks, dq 0
  1474 0000121C 0000000000000000    <1>  at STAT_STRUC.st_atime, dq 0
  1475 00001224 0000000000000000    <1>  at STAT_STRUC.st_atime_nsec, dq 0
  1476 0000122C 0000000000000000    <1>  at STAT_STRUC.st_mtime, dq 0
  1477 00001234 0000000000000000    <1>  at STAT_STRUC.st_mtime_nsec, dq 0
  1478 0000123C 0000000000000000    <1>  at STAT_STRUC.st_ctime, dq 0
  1479 00001244 0000000000000000    <1>  at STAT_STRUC.st_ctime_nsec, dq 0
  1480 0000124C 0000000000000000    <1>  at STAT_STRUC._unused1, dq 0
  1481 00001254 0000000000000000    <1>  at STAT_STRUC._unused2, dq 0
  1482 0000125C 0000000000000000    <1>  at STAT_STRUC._unused3, dq 0
  1483                              <1>  IEND
  1484                              <1> 
  1485                              <1> 
  1486                              <1> 
  1487                              <1>  %define %1.st_dev %1+STAT_STRUC.st_dev
  1488                              <1>  %define %1.st_ino %1+STAT_STRUC.st_ino
  1489                              <1>  %define %1.st_nlink %1+STAT_STRUC.st_nlink
  1490                              <1>  %define %1.st_mod %1+STAT_STRUC.st_mod
  1491                              <1>  %define %1.st_uid %1+STAT_STRUC.st_uid
  1492                              <1>  %define %1.st_gid %1+STAT_STRUC.st_gid
  1493                              <1>  %define %1.st_rdev %1+STAT_STRUC.st_rdev
  1494                              <1>  %define %1._pad1 %1+STAT_STRUC._pad1
  1495                              <1>  %define %1.st_size %1+STAT_STRUC.st_size
  1496                              <1>  %define %1.st_blksize %1+STAT_STRUC.st_blksize
  1497                              <1>  %define %1._pad2 %1+STAT_STRUC._pad2
  1498                              <1>  %define %1.st_blocks %1+STAT_STRUC.st_blocks
  1499                              <1>  %define %1.st_atime %1+STAT_STRUC.st_atime
  1500                              <1>  %define %1.st_atime_nsec %1+STAT_STRUC.st_atime_nsec
  1501                              <1>  %define %1.st_mtime %1+STAT_STRUC.st_mtime
  1502                              <1>  %define %1.st_mtime_nsec %1+STAT_STRUC.st_mtime_nsec
  1503                              <1>  %define %1.st_ctime %1+STAT_STRUC.st_ctime
  1504                              <1>  %define %1.st_ctime_nsec %1+STAT_STRUC.st_ctime_nsec
  1505                              <1>  %define %1._unused1 %1+STAT_STRUC._unused1
  1506                              <1>  %define %1._unused2 %1+STAT_STRUC._unused2
  1507                              <1>  %define %1._unused3 %1+STAT_STRUC._unused3
  1508                                  	TERMIOS termios
  1509                              <1>  %1: ISTRUC TERMIOS_STRUC
  1510 00001264 00000000            <1>  at TERMIOS_STRUC.c_iflag, dd 0
  1511 00001268 00000000            <1>  at TERMIOS_STRUC.c_oflag, dd 0
  1512 0000126C 00000000            <1>  at TERMIOS_STRUC.c_cflag, dd 0
  1513 00001270 00000000            <1>  at TERMIOS_STRUC.c_lflag, dd 0
  1514 00001274 00                  <1>  at TERMIOS_STRUC.c_line, db 0
  1515 00001275 00<rept>            <1>  at TERMIOS_STRUC.c_cc, times 19 db 0
  1516                              <1>  IEND
  1517                              <1>  %define %1.c_iflag %1+TERMIOS_STRUC.c_iflag
  1518                              <1>  %define %1.c_oflag %1+TERMIOS_STRUC.c_oflag
  1519                              <1>  %define %1.c_cflag %1+TERMIOS_STRUC.c_cflag
  1520                              <1>  %define %1.c_lflag %1+TERMIOS_STRUC.c_lflag
  1521                              <1>  %define %1.c_line %1+TERMIOS_STRUC.c_line
  1522                              <1>  %define %1.c_cc %1+TERMIOS_STRUC.c_cc
  1523                                  	
  1524                                  section .text
  1525                                  
  1526                                  global _start
  1527                                  _start:
  1528                                  
  1529 00000000 58                          pop     rax             	; argc
  1530 00000001 4883F804                    cmp     rax, ARGC
  1531 00000005 7402                        je      parseCommandLine	; argumentcount is correct
  1532 00000007 EB1E                        jmp		usage
  1533                                  parseCommandLine:    
  1534 00000009 58                          pop     rax             ; pointer to programname
  1535 0000000A 5E                          pop     rsi             ; pointer to sourcefilename
  1536 0000000B 58                          pop     rax             ; read option -o
  1537 0000000C 5F                          pop		rdi				; pointer to destination file
  1538 0000000D 668B00                      mov     ax, WORD[rax]
  1539 00000010 663D2D6F                    cmp     ax, "-o"        ; option -o?
  1540 00000014 7427                        je      checkFiles
  1541 00000016 48C7C079FFFFFF              mov		rax, EILEGALOPTION
  1542 0000001D E8B9020000                  call	getError
  1543 00000022 E833030000                  call	PrintSTDERR
  1544                                  usage:
  1545 00000027 48C7C07AFFFFFF              mov		rax, ESHOWUSAGE
  1546 0000002E E8A8020000                  call	getError
  1547 00000033 E822030000                  call	PrintSTDERR
  1548 00000038 E992020000                  jmp		exit
  1549                                  
  1550                                  checkFiles:
  1551                                      ; RSI has the pointer to the sourcefile
  1552                                      ; RDI has the pointer to the destinationfile
  1553                                      
  1554 0000003D 48893425[10000000]          mov     QWORD[ptrSourceFile], rsi
  1555 00000045 48893C25[18000000]          mov     QWORD[ptrDestinationFile], rdi
  1556                                      
  1557                                      ; Open the source file
  1558 0000004D 488B3C25[10000000]          mov     rdi, QWORD [ptrSourceFile]
  1559 00000055 BE00000000                  mov     rsi, O_RDONLY
  1560 0000005A B802000000                  mov     rax, SYS_OPEN
  1561 0000005F 0F05                        syscall
  1562 00000061 4883F800                    cmp     rax, 0
  1563 00000065 7F12                        jg      gotfdsource						; we got a filedescriptor
  1564 00000067 488B3425[10000000]          mov		rsi, QWORD [ptrSourceFile]
  1565 0000006F E89C020000                  call	PrintFileError
  1566 00000074 E956020000                  jmp		exit
  1567                                  gotfdsource:
  1568                                  	; save the descriptor for later use
  1569 00000079 48890425[00000000]          mov     [fdsource], rax
  1570                                      
  1571                                      ; try to open the destination file
  1572 00000081 488B3C25[18000000]          mov     rdi, QWORD[ptrDestinationFile]
  1573 00000089 BE02000000                  mov     rsi, O_RDWR						; open in read/write mode
  1574 0000008E B802000000                  mov     rax, SYS_OPEN
  1575 00000093 0F05                        syscall
  1576 00000095 4883F800                    cmp     rax, 0              ; file exists?
  1577 00000099 7C6B                        jl      createfile          ; file doesn't exists, create it
  1578                                      
  1579 0000009B 48890425[08000000]          mov		QWORD[fddestination], rax			; save fd
  1580 000000A3 488B3425[18000000]          mov		rsi, QWORD [ptrDestinationFile]
  1581 000000AB 48C7C078FFFFFF              mov		rax, EFILEEXISTS		
  1582 000000B2 E859020000                  call	PrintFileError
  1583                                      
  1584                                  continueWaiting:
  1585 000000B7 E8C4020000                  call	WaitForKeyPress
  1586 000000BC 3C59                        cmp		al,"Y"
  1587 000000BE 7404                        je		gotAnswer
  1588 000000C0 3C6E                        cmp		al,"n"
  1589 000000C2 75F3                        jne		continueWaiting      
  1590                                  gotAnswer:
  1591 000000C4 50                      	push	rax						; save the answer
  1592                                  	; print the users answer
  1593 000000C5 48BE-                   	mov		rsi, buffer
  1594 000000C7 [2000000000000000] 
  1595 000000CF BA01000000              	mov		rdx, 1
  1596 000000D4 E89B020000              	call	Print
  1597 000000D9 48BE-                   	mov		rsi, CRLFmsg
  1598 000000DB [C211000000000000] 
  1599 000000E3 E88C020000              	call	Print
  1600 000000E8 58                          pop		rax						; retrieve the answer
  1601 000000E9 3C59                        cmp		al,"Y"
  1602 000000EB 744D                        je		startAssembling
  1603                                      
  1604                                      ; we may not use the existing destination file,
  1605                                      ; inform user, ask to select other name or quit
  1606 000000ED 488B3425[18000000]          mov		rsi, QWORD[ptrDestinationFile]
  1607 000000F5 48C7C077FFFFFF              mov		rax, ENOTUSING
  1608 000000FC E80F020000                  call	PrintFileError
  1609 00000101 E9AB010000                  jmp		closeDestinationFile
  1610                                      
  1611                                  createfile:
  1612                                      ; file doesn't exists, create the file with permissions 644 octal,
  1613                                      ; taking umask in consideration
  1614 00000106 488B3C25[18000000]          mov     rdi, QWORD [ptrDestinationFile]
  1615 0000010E BEA4010000                  mov     rsi, 644q              ; access mode
  1616 00000113 B855000000                  mov     rax, SYS_CREAT
  1617 00000118 0F05                        syscall
  1618                                      ; if we got a file descriptor then the file is created
  1619 0000011A 4883F800                    cmp     rax, 0
  1620 0000011E 7D12                        jge     savefddestination
  1621                                      ; we got an error creating the file, inform user and close fd source
  1622 00000120 488B3425[18000000]          mov		rsi, QWORD [ptrDestinationFile]
  1623 00000128 E8E3010000                  call	PrintFileError
  1624 0000012D E98E010000                  jmp		closeSourceFile
  1625                                      
  1626                                  savefddestination:
  1627 00000132 48890425[08000000]          mov		QWORD[fddestination], rax
  1628                                      
  1629                                  startAssembling:
  1630                                  
  1631                                  ; read the length of the source file
  1632 0000013A 488B3C25[00000000]            mov   rdi, QWORD[fdsource]
  1633 00000142 48BE-                         mov   rsi, stat
  1634 00000144 [D411000000000000] 
  1635 0000014C B805000000                    mov   rax, SYS_FSTAT
  1636 00000151 0F05                          syscall
  1637 00000153 4883F800                      cmp	rax, 0
  1638 00000157 0F8C25010000                  jl	fileStatError
  1639                                              
  1640                                  readFileSize:
  1641 0000015D 488B0C25[04120000]            mov   rcx, QWORD [stat.st_size]   	; get the file size
  1642 00000165 C60425[2A000000]01            mov	BYTE[firstCharInLine], 1		; set first char in line true
  1643 0000016D C60425[29000000]00            mov	BYTE[ignoreLine], 0				; set ignore line false
  1644                                        ; start reading file contents
  1645                                        
  1646                                  readFileContents:
  1647                                  	  
  1648                                  	  ; int 3  DEBUGGING
  1649                                  	  
  1650                                        ; for all bytes in file do
  1651 00000175 51                            push  rcx
  1652 00000176 48BE-                         mov   rsi, buffer
  1653 00000178 [2000000000000000] 
  1654 00000180 BA01000000                    mov   rdx, 1          				; read one char at the time
  1655 00000185 B800000000                    mov   rax, SYS_READ
  1656 0000018A 0F05                          syscall
  1657 0000018C 4883F800                      cmp	rax, 0
  1658 00000190 0F8EEC000000                  jle	fileStatError					; in case of an error treat it as a file status error
  1659                                        
  1660                                        ; no read error, start parsing
  1661 00000196 8A0425[20000000]              mov	al, BYTE[buffer]
  1662 0000019D 3C0A                          cmp	al, 0x0A
  1663 0000019F 7404                          je	eol
  1664 000001A1 3C0D                          cmp	al, 0x0D  
  1665 000001A3 7516                          jne	noeol
  1666                                  eol:
  1667 000001A5 48830425[21000000]-           add	QWORD[sourcelines],1
  1668 000001AD 01                 
  1669 000001AE C60425[29000000]00            mov	BYTE[ignoreLine], 0				; if EOL in remark ine set ignore line false
  1670 000001B6 E999000000                    jmp	readNextByte
  1671                                        
  1672                                  noeol:
  1673 000001BB 3C23                    	  cmp	al, '#'							; if remark, ignore all following chars until 0x0A is met
  1674 000001BD 750D                    	  jne	nocomment
  1675 000001BF C60425[29000000]01      	  mov	BYTE[ignoreLine], 1				; set ignore line true
  1676 000001C7 E988000000              	  jmp	readNextByte
  1677                                  	  
  1678                                  nocomment:
  1679 000001CC 803C25[29000000]01      	  cmp	BYTE[ignoreLine],1				; if ignore line true then don't parse
  1680 000001D4 747E                    	  je	readNextByte
  1681                                  	  
  1682 000001D6 3C20                    	  cmp	al, ' '							; if a space is met, read the next byte
  1683 000001D8 747A                    	  je	readNextByte
  1684                                  	  
  1685 000001DA 3C09                    	  cmp	al, 0x09						; if a tab is met, read the next byte
  1686 000001DC 7476                    	  je	readNextByte
  1687                                  	  
  1688 000001DE 3C52                    	  cmp	al, 'R'
  1689 000001E0 746B                    	  je	writeChar
  1690                                  	  
  1691 000001E2 3C30                          cmp	al,'0'					; possible registernumbers, if second and right after R then third must be ':'
  1692 000001E4 7467                    	  je	writeChar
  1693                                  
  1694 000001E6 3C31                          cmp	al,'1'					; else memory address, nothing but spaces or '#' allowed
  1695 000001E8 7463                    	  je	writeChar
  1696                                  
  1697 000001EA 3C32                          cmp	al,'2'
  1698 000001EC 745F                    	  je	writeChar
  1699                                  
  1700 000001EE 3C33                          cmp	al,'3'
  1701 000001F0 745B                    	  je	writeChar
  1702                                  
  1703 000001F2 3C34                          cmp	al,'4'
  1704 000001F4 7457                    	  je	writeChar
  1705                                  
  1706 000001F6 3C35                          cmp	al,'5'
  1707 000001F8 7453                    	  je	writeChar
  1708                                  
  1709 000001FA 3C36                          cmp	al,'6'
  1710 000001FC 744F                    	  je	writeChar
  1711                                  
  1712 000001FE 3C37                          cmp	al,'7'
  1713 00000200 744B                    	  je	writeChar
  1714                                  
  1715 00000202 3C38                          cmp	al,'8'
  1716 00000204 7447                    	  je	writeChar
  1717                                  
  1718 00000206 3C39                          cmp	al,'9'
  1719 00000208 7443                    	  je	writeChar
  1720                                  
  1721 0000020A 3C41                          cmp	al,'A'
  1722 0000020C 743F                    	  je	writeChar
  1723                                  
  1724 0000020E 3C42                          cmp	al,'B'
  1725 00000210 743B                    	  je	writeChar
  1726                                  
  1727 00000212 3C43                          cmp	al,'C'
  1728 00000214 7437                    	  je	writeChar
  1729                                  
  1730 00000216 3C44                          cmp	al,'D'
  1731 00000218 7433                    	  je	writeChar
  1732                                  
  1733 0000021A 3C45                          cmp	al,'E'
  1734 0000021C 742F                    	  je	writeChar
  1735                                  
  1736 0000021E 3C46                          cmp	al,'F'
  1737 00000220 742B                    	  je	writeChar
  1738                                  
  1739 00000222 3C48                          cmp	al,'H'
  1740 00000224 7427                    	  je	writeChar
  1741                                  
  1742 00000226 3C4C                          cmp	al,'L'
  1743 00000228 7423                    	  je	writeChar
  1744                                  
  1745 0000022A 3C4F                          cmp	al,'O'
  1746 0000022C 741F                    	  je	writeChar
  1747                                  
  1748 0000022E 3C53                          cmp   al,'S'
  1749 00000230 741B                    	  je	writeChar
  1750                                  
  1751 00000232 3C54                          cmp	al,'T'
  1752 00000234 7417                    	  je	writeChar
  1753                                  
  1754 00000236 3C55                          cmp   al,'U'
  1755 00000238 7413                    	  je	writeChar
  1756                                  	  
  1757 0000023A 48C7C076FFFFFF          	  mov	rax, EILEGALCHAR
  1758 00000241 E895000000              	  call	getError
  1759 00000246 E81C010000              	  call	PrintSTDOUT
  1760 0000024B EB64                    	  jmp   closeDestinationFile  
  1761                                  
  1762                                  writeChar:
  1763 0000024D E8ED000000              	  call	PrintBuffer
  1764 00000252 7400                    	  je	readNextByte
  1765                                  	  	  
  1766                                  readNextByte:	  
  1767 00000254 59                      	  pop	rcx
  1768 00000255 48FFC9                  	  dec	rcx
  1769 00000258 4883F900                	  cmp	rcx, 0
  1770 0000025C 0F8513FFFFFF            	  jne	readFileContents  
  1771                                  
  1772                                  ; END OF ASSEMBLING
  1773                                  endAssembling:
  1774                                      ; save the assembled binary
  1775 00000262 488B3C25[08000000]          mov		rdi, QWORD[fddestination]
  1776 0000026A 48BE-                       mov		rsi, binary
  1777 0000026C [C311000000000000] 
  1778 00000274 BA11000000                  mov		rdx, binary.length
  1779 00000279 B801000000                  mov		rax, SYS_WRITE
  1780 0000027E 0F05                        syscall
  1781 00000280 EB2F                    	jmp		closeDestinationFile
  1782                                  	
  1783                                  fileStatError:
  1784 00000282 488B3425[10000000]      	mov		rsi, QWORD[ptrSourceFile]
  1785 0000028A E881000000              	call	PrintFileError
  1786                                  	
  1787                                  deleteDestinationFile:	
  1788 0000028F 488B3C25[18000000]      	mov		rdi, QWORD[ptrDestinationFile]
  1789 00000297 B857000000              	mov		rax, SYS_UNLINK
  1790 0000029C 0F05                    	syscall
  1791 0000029E 4883F800                	cmp		rax, 0
  1792 000002A2 7D0D                    	jge		closeDestinationFile
  1793 000002A4 488B3425[18000000]      	mov		rsi, QWORD[ptrDestinationFile]
  1794 000002AC E85F000000              	call	PrintFileError
  1795                                  
  1796                                  closeDestinationFile:
  1797 000002B1 488B3C25[08000000]      	mov		rdi, QWORD[fddestination]
  1798 000002B9 B803000000              	mov		rax, SYS_CLOSE
  1799 000002BE 0F05                    	syscall
  1800                                  closeSourceFile:	
  1801 000002C0 488B3C25[00000000]      	mov		rdi, QWORD[fdsource]
  1802 000002C8 B803000000              	mov		rax, SYS_CLOSE
  1803 000002CD 0F05                    	syscall
  1804                                  	   
  1805                                  exit:        
  1806 000002CF BF00000000                  mov     rdi, 0
  1807 000002D4 B83C000000                  mov     rax, SYS_EXIT
  1808 000002D9 0F05                        syscall
  1809                                  ;*********************************************
  1810                                  ; END PROGRAM
  1811                                  ;*********************************************
  1812                                  
  1813                                  ; SUBROUTINES
  1814                                  getError:
  1815                                  	; RAX has the error number
  1816 000002DB 48F7D8                  	neg		rax						; get positive value
  1817 000002DE 48FFC8                  	dec		rax						; decrement to adjust in list
  1818 000002E1 48C1E003                	shl		rax, 3					; multiplicate with 8 (8 bytes = 64 bits)
  1819 000002E5 488BB0[00000000]        	mov		rsi, [errorList+rax] 	; load the error message pointer
  1820 000002EC E801000000              	call	getStringLength
  1821 000002F1 C3                      	ret
  1822                                  	
  1823                                  getStringLength:
  1824                                  	; RSI has the pointer to the string	
  1825 000002F2 50                      	push	rax
  1826 000002F3 51                      	push	rcx
  1827 000002F4 57                      	push	rdi
  1828 000002F5 4889F7                  	mov		rdi, rsi
  1829 000002F8 48C7C1FFFFFFFF          	mov     rcx, -1				; calculate the length
  1830 000002FF 30C0                        xor     al, al            	; search for terminating 0
  1831 00000301 F2AE                        repne   scasb
  1832 00000303 48F7D9                      neg     rcx
  1833 00000306 48FFC9                      dec     rcx
  1834 00000309 4889CA                      mov		rdx, rcx			; length in RDX
  1835 0000030C 5F                          pop		rdi
  1836 0000030D 59                          pop		rcx
  1837 0000030E 58                          pop		rax
  1838 0000030F C3                      	ret
  1839                                  
  1840                                  PrintFileError:
  1841                                  	; RAX has the errornumber
  1842                                  	; RSI has the pointer to the filename
  1843 00000310 56                      	push	rsi
  1844 00000311 50                      	push	rax
  1845 00000312 50                      	push	rax	      
  1846 00000313 E8DAFFFFFF                  call	getStringLength
  1847 00000318 E83D000000                  call	PrintSTDERR
  1848 0000031D 48BE-                       mov		rsi, COLONmsg
  1849 0000031F [C011000000000000] 
  1850 00000327 BA02000000                  mov		rdx, COLONmsg.length
  1851 0000032C E829000000                  call	PrintSTDERR
  1852 00000331 58                          pop		rax
  1853 00000332 E8A4FFFFFF                  call	getError
  1854 00000337 E81E000000                  call	PrintSTDERR
  1855 0000033C 58                      	pop		rax
  1856 0000033D 5E                      	pop		rsi
  1857 0000033E C3                      	ret
  1858                                  
  1859                                  PrintBuffer:
  1860 0000033F 51                      	  push	rcx
  1861 00000340 56                      	  push	rsi
  1862 00000341 52                      	  push	rdx
  1863 00000342 48BE-                   	  mov	rsi, buffer
  1864 00000344 [2000000000000000] 
  1865 0000034C BA01000000              	  mov	rdx, 1
  1866 00000351 E811000000              	  call	PrintSTDOUT
  1867 00000356 5A                      	  pop	rdx
  1868 00000357 5E                      	  pop	rsi
  1869 00000358 59                      	  pop	rcx
  1870 00000359 C3                      	  ret
  1871                                  
  1872                                  PrintSTDERR:
  1873                                  	  ; RSI has the pointer to the string
  1874                                  	  ; RDX has the length to the string
  1875 0000035A 57                      	  push	rdi
  1876 0000035B BF02000000              	  mov	rdi, STDERR
  1877 00000360 E80F000000              	  call	Print
  1878 00000365 5F                      	  pop	rdi
  1879 00000366 C3                      	  ret
  1880                                        
  1881                                  PrintSTDOUT:
  1882 00000367 57                      	  push	rdi
  1883 00000368 BF01000000              	  mov	rdi, STDOUT
  1884 0000036D E802000000              	  call	Print
  1885 00000372 5F                      	  pop	rdi
  1886 00000373 C3                      	  ret
  1887                                  	  
  1888                                  Print:	  
  1889 00000374 50                            push  rax
  1890 00000375 51                            push  rcx
  1891 00000376 B801000000                    mov   rax, SYS_WRITE
  1892 0000037B 0F05                          syscall
  1893 0000037D 59                            pop   rcx
  1894 0000037E 58                            pop   rax
  1895 0000037F C3                            ret		
  1896                                  
  1897                                  WaitForKeyPress:
  1898                                  	; read a key without echoing it back and put the key in a buffer
  1899                                  	; the buffer is 1 byte long
  1900 00000380 E839000000              	call    TermIOS.Canonical.OFF      ; switch canonical mode off
  1901 00000385 E842000000                  call    TermIOS.Echo.OFF           ; no echo
  1902 0000038A 48BE-                       mov     rsi, buffer
  1903 0000038C [2000000000000000] 
  1904 00000394 BA01000000                  mov     rdx, 1
  1905 00000399 BF00000000                  mov     rdi, STDIN
  1906 0000039E B800000000                  mov     rax, SYS_READ
  1907 000003A3 0F05                        syscall
  1908                                      ; Don't forget to switch canonical mode en echo back on
  1909 000003A5 E80D000000                  call    TermIOS.Canonical.ON       ; switch canonical mode back on
  1910 000003AA E816000000                  call    TermIOS.Echo.ON            ; echo on
  1911 000003AF 8A0425[20000000]            mov		al, BYTE[buffer]
  1912 000003B6 C3                          ret
  1913                                      
  1914                                  ; **********************************************************************************************    
  1915                                  ; TERMIOS functions:
  1916                                  ; TermIOS.Canonical.ON        : switch canonical mode on
  1917                                  ; TermIOS.Canonical.OFF       : switch canonical mode off
  1918                                  ; TermIOS.Echo.ON             : switch echo mode on
  1919                                  ; TermIOS.Echo.OFF            : switch echo mode off
  1920                                  ; TermIOS.LocalModeFlag.SET   : set the localmode flag described in RAX
  1921                                  ; TermIOS.LocalModeFlag.CLEAR : clear the localmode flag described in RAX 
  1922                                  ; TermIOS.STDIN.Read          : Read the TERMIO flags
  1923                                  ; TermIOS.STDIN.Write         : Write the TERMIO flags
  1924                                  ; TermIOS.IOCTL               : Read or write the localmode flags to or from TERMIOS
  1925                                  ; **********************************************************************************************
  1926                                  
  1927                                  TermIOS.Canonical:
  1928                                  .ON:
  1929 000003B7 B802000000                  mov     rax, ICANON
  1930 000003BC EB15                        jmp     TermIOS.LocalModeFlag.SET
  1931                                  .OFF:
  1932 000003BE B802000000                  mov     rax,ICANON
  1933 000003C3 EB20                        jmp     TermIOS.LocalModeFlag.CLEAR
  1934                                  TermIOS.Echo:
  1935                                  .ON:
  1936 000003C5 B80A000000                  mov     rax,ECHO
  1937 000003CA EB07                        jmp     TermIOS.LocalModeFlag.SET
  1938                                  .OFF:
  1939 000003CC B80A000000                  mov     rax,ECHO
  1940 000003D1 EB12                        jmp     TermIOS.LocalModeFlag.CLEAR
  1941                                  TermIOS.LocalModeFlag:
  1942                                  .SET:
  1943 000003D3 E821000000                  call    TermIOS.STDIN.READ
  1944 000003D8 090425[70120000]            or      dword [termios.c_lflag], eax
  1945 000003DF E81C000000                  call    TermIOS.STDIN.WRITE
  1946 000003E4 C3                          ret
  1947                                  .CLEAR:
  1948 000003E5 E80F000000                  call    TermIOS.STDIN.READ
  1949 000003EA F7D0                        not     eax
  1950 000003EC 210425[70120000]            and     [termios.c_lflag], eax
  1951 000003F3 E808000000                  call    TermIOS.STDIN.WRITE
  1952 000003F8 C3                          ret
  1953                                  ; subroutine for all TCGETS operation on the syscall IOCTL
  1954                                  ; the original value of RCX is restored on exit
  1955                                  TermIOS.STDIN:
  1956                                  .READ:
  1957 000003F9 BE01540000                  mov     rsi, TCGETS
  1958 000003FE EB05                        jmp     TermIOS.IOCTL
  1959                                  ; subroutine for all TCSETS operation on the syscall IOCTL
  1960                                  ; the original value of RCX is restored on exit
  1961                                  .WRITE:
  1962 00000400 BE02540000                  mov     rsi, TCSETS
  1963                                  ; subroutine for operations on the syscall IOCTL for STDIN
  1964                                  ; all registers are restored to their original values on exit of the subroutine
  1965                                  TermIOS.IOCTL:
  1966 00000405 50                          push    rax             ; we need to store RAX or TermIOS.LocalFlag functions fail
  1967 00000406 B810000000                  mov     rax, SYS_IOCTL
  1968 0000040B BF00000000                  mov     rdi, STDIN
  1969 00000410 48BA-                       mov     rdx, termios
  1970 00000412 [6412000000000000] 
  1971 0000041A 0F05                        syscall
  1972 0000041C 58                          pop     rax
  1973 0000041D C3                          ret
